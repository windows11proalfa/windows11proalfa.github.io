<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiroko AI - Kawaii & Intelligent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-body: #fff9fb;
            --sidebar-bg: #ffffff;
            --primary-pink: #ff85b3;
            --soft-pink: #ffe3ed;
            --text-color: #5a4b4f;
            --border-color: #fce4ec;
        }

        .dark {
            --bg-body: #1a1617;
            --sidebar-bg: #251d1f;
            --primary-pink: #ff85b3;
            --soft-pink: #3d2b2f;
            --text-color: #fce4ec;
            --border-color: #3d2b2f;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Quicksand', sans-serif;
            background-image: radial-gradient(var(--soft-pink) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .kawaii-sidebar {
            background-color: var(--sidebar-bg);
            border-right: 2px solid var(--border-color);
            box-shadow: 4px 0 15px rgba(255, 133, 179, 0.05);
        }

        /* Message Bubbles */
        .chat-bubble-user {
            background-color: var(--primary-pink);
            color: white;
            border-radius: 20px 20px 4px 20px;
            box-shadow: 0 4px 12px rgba(255, 133, 179, 0.2);
        }

        .chat-bubble-ai {
            background-color: var(--sidebar-bg);
            color: var(--text-color);
            border: 2px solid var(--soft-pink);
            border-radius: 20px 20px 20px 4px;
        }

        /* Markdown Styles */
        .prose pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 12px;
            margin: 0.5rem 0;
            position: relative;
            overflow-x: auto;
        }
        .prose code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .copy-btn:hover { opacity: 1; }

        /* Session Styling */
        .session-item {
            transition: all 0.3s ease;
            border-radius: 15px;
            cursor: pointer;
            margin-bottom: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
        }

        .session-item:hover {
            background-color: var(--soft-pink);
            transform: translateX(5px);
        }

        .session-active {
            background-color: var(--soft-pink);
            border-color: var(--primary-pink);
            font-weight: 700;
        }

        .input-field {
            background-color: var(--sidebar-bg);
            color: var(--text-color);
            border: 2px solid var(--soft-pink);
            transition: all 0.3s;
            border-radius: 18px;
        }

        .input-field:focus {
            border-color: var(--primary-pink);
            outline: none;
            box-shadow: 0 0 15px rgba(255, 133, 179, 0.2);
        }

        .btn-kawaii {
            background: linear-gradient(135deg, #ff85b3, #ffb3d1);
            color: white;
            border-radius: 18px;
            transition: all 0.3s;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .typing-dot { animation: bounce 0.6s infinite alternate; }

        @media (max-width: 768px) {
            .sidebar-closed { transform: translateX(-100%); position: absolute; z-index: 50; }
            .sidebar-open { transform: translateX(0); position: absolute; z-index: 50; }
        }

        .auth-hidden { display: none !important; }
        .glass-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row">

    <div id="mobile-nav" class="auth-hidden md:hidden glass-header w-full p-4 flex justify-between items-center border-b border-pink-100">
        <button onclick="toggleSidebar()" class="text-pink-500 text-2xl">‚ò∞</button>
        <span class="font-bold text-pink-500">Shiroko üå∏</span>
        <div class="w-8"></div>
    </div>

    <button onclick="toggleTheme()" class="fixed bottom-6 right-6 p-4 rounded-full bg-white dark:bg-zinc-800 border-2 border-pink-200 text-pink-500 z-50 shadow-lg transition-all">
        <span id="theme-icon">üåô</span>
    </button>

    <aside id="sidebar" class="auth-hidden sidebar-closed md:relative md:translate-x-0 flex flex-col w-72 kawaii-sidebar h-full transition-transform duration-300 ease-in-out">
        <div class="p-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-pink-500 flex items-center gap-2">
                <span class="animate-pulse">ü¶ä</span> Shiroko
            </h1>
            <button onclick="toggleSidebar()" class="md:hidden text-pink-300 text-xl">‚úï</button>
        </div>
        
        <div class="px-6 pb-4">
            <button onclick="startNewSession()" class="w-full py-3 btn-kawaii font-bold flex items-center justify-center gap-2 shadow-lg">
                <span>‚ú®</span> Chat Baru
            </button>
        </div>

        <div id="session-list" class="flex-1 overflow-y-auto px-4 no-scrollbar space-y-1"></div>

        <div class="p-6 mt-auto">
            <div class="bg-pink-50 dark:bg-zinc-800/50 p-4 rounded-2xl flex flex-col gap-2 border border-pink-100">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span id="display-user" class="text-sm font-bold truncate"></span>
                </div>
                <button onclick="handleLogout()" class="text-xs text-pink-400 hover:text-pink-600 text-left font-bold">Logout Senpai üëã</button>
            </div>
        </div>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col h-full w-full relative">
        <!-- Auth View -->
        <div id="auth-container" class="flex-1 flex items-center justify-center p-6">
            <div class="w-full max-w-sm bg-white dark:bg-zinc-900 p-10 rounded-[40px] shadow-2xl border-4 border-pink-100 space-y-8">
                <div class="text-center">
                    <div class="text-5xl mb-4">ü¶ä</div>
                    <h2 id="auth-title" class="text-3xl font-bold text-pink-500">Shiroko AI</h2>
                    <p class="text-pink-300 text-sm font-medium">Hewwo! Silakan masuk Senpai~</p>
                </div>
                <div id="auth-msg" class="hidden text-center text-xs font-bold p-3 rounded-2xl"></div>
                
                <div id="login-form" class="space-y-4">
                    <input type="text" id="username" placeholder="Username" class="w-full p-4 input-field text-center">
                    <input type="password" id="password" placeholder="Password" class="w-full p-4 input-field text-center">
                    <button onclick="handleLogin()" class="w-full py-4 btn-kawaii font-bold text-lg">Masuk Yuk! üå∏</button>
                    <p class="text-center text-xs font-medium">Belum ada akun? <a href="javascript:void(0)" onclick="toggleAuth(false)" class="text-pink-500">Daftar Akun</a></p>
                </div>

                <div id="register-form" class="space-y-4 hidden">
                    <input type="text" id="reg-username" placeholder="Username Baru" class="w-full p-4 input-field text-center">
                    <input type="password" id="reg-password" placeholder="Password Baru" class="w-full p-4 input-field text-center">
                    <button onclick="handleRegister()" class="w-full py-4 btn-kawaii font-bold text-lg">Buat Akun ü¶ä</button>
                    <p class="text-center text-xs font-medium">Sudah ada akun? <a href="javascript:void(0)" onclick="toggleAuth(true)" class="text-pink-500">Login Aja</a></p>
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="flex-1 flex flex-col hidden overflow-hidden">
            <header class="p-6 flex items-center justify-between glass-header border-b border-pink-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center text-xl">ü¶ä</div>
                    <div>
                        <h3 id="chat-header-title" class="font-bold text-pink-600 text-sm">Utama</h3>
                        <p class="text-[10px] text-green-400 font-bold uppercase">Online & Ready ‚ú®</p>
                    </div>
                </div>
            </header>

            <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8 no-scrollbar w-full max-w-5xl mx-auto"></div>

            <div id="image-preview-container" class="px-10 py-4 hidden">
                <div class="relative inline-block">
                    <img id="image-preview" src="" class="h-24 w-24 object-cover rounded-2xl border-4 border-white shadow-xl">
                    <button onclick="clearImage()" class="absolute -top-3 -right-3 bg-pink-500 text-white rounded-full w-7 h-7 flex items-center justify-center">√ó</button>
                </div>
            </div>

            <div class="p-6 md:p-10">
                <div class="max-w-4xl mx-auto flex gap-4 items-end bg-white dark:bg-zinc-800 p-3 rounded-[30px] shadow-xl border-2 border-pink-50">
                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="previewImage(this)">
                    <button onclick="document.getElementById('file-input').click()" class="p-4 text-2xl">üñºÔ∏è</button>
                    <textarea id="user-input" rows="1" placeholder="Pesan buat Shiroko..." class="flex-1 p-4 bg-transparent focus:outline-none resize-none max-h-40 text-sm" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="bg-pink-500 text-white p-4 rounded-2xl font-bold transition shadow-md">KIRIM</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let sessions = [];
        let activeSessionId = null;
        let selectedImageUrl = "";

        const SYSTEM_PROMPT = `Shiroko personality: Cute, helpful, intelligent anime girl. Respond in Bahasa Indonesia. Act as a friendly AI named Shiroko. Use Markdown for formatting and code blocks. Developed by AI Empower.`;

        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (Math.random()*16|0).toString(16)); }

        // Core Fix: Proper window.onload for persistence
        window.addEventListener('load', () => {
            const loggedInUser = localStorage.getItem('shiro_active_user');
            if (loggedInUser) {
                currentUser = loggedInUser;
                initApp();
            }
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-closed');
            sidebar.classList.toggle('sidebar-open');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            document.getElementById('theme-icon').innerText = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleAuth(isLogin) {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
        }

        function showAuthMsg(text, isError = true) {
            const msgEl = document.getElementById('auth-msg');
            msgEl.innerText = text;
            msgEl.className = `block text-center p-3 rounded-2xl text-xs font-bold ${isError ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}`;
            setTimeout(() => msgEl.classList.add('hidden'), 3000);
        }

        function handleRegister() {
            const u = document.getElementById('reg-username').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            if(!u || !p) return showAuthMsg("Data belum lengkap!");
            localStorage.setItem(`shiro_user_${u}`, p);
            showAuthMsg("Berhasil daftar! ‚ú®", false);
            toggleAuth(true);
        }

        function handleLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(localStorage.getItem(`shiro_user_${u}`) === p) {
                currentUser = u;
                localStorage.setItem('shiro_active_user', u);
                initApp();
            } else showAuthMsg("Salah password/user!");
        }

        function initApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('auth-hidden');
            document.getElementById('mobile-nav')?.classList.remove('auth-hidden');
            document.getElementById('chat-view').classList.remove('hidden');
            document.getElementById('display-user').innerText = `üå∏ ${currentUser}`;
            
            const saved = localStorage.getItem(`shiro_sessions_${currentUser}`);
            if(saved) {
                sessions = JSON.parse(saved);
                if(sessions.length > 0) selectSession(sessions[0].id);
                else startNewSession();
            } else startNewSession();
            renderSessions();
        }

        function startNewSession() {
            const newId = generateUUID();
            sessions.unshift({ id: newId, title: "Chat Baru ‚ú®", messages: [] });
            activeSessionId = newId;
            saveData();
            renderSessions();
            selectSession(newId);
        }

        function renderSessions() {
            const list = document.getElementById('session-list');
            list.innerHTML = '';
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = `session-item ${s.id === activeSessionId ? 'session-active' : ''}`;
                div.innerHTML = `<span class="truncate text-sm flex-1">${s.title}</span><button onclick="deleteSession(event, '${s.id}')" class="px-2">‚úï</button>`;
                div.onclick = () => selectSession(s.id);
                list.appendChild(div);
            });
        }

        function deleteSession(e, id) {
            e.stopPropagation();
            sessions = sessions.filter(s => s.id !== id);
            if(sessions.length === 0) startNewSession();
            else if(activeSessionId === id) selectSession(sessions[0].id);
            saveData();
            renderSessions();
        }

        function selectSession(id) {
            activeSessionId = id;
            const session = sessions.find(s => s.id === id);
            document.getElementById('chat-header-title').innerText = session.title;
            document.getElementById('chat-box').innerHTML = '';
            session.messages.forEach(m => renderMessage(m.sender, m.text, m.image));
            renderSessions();
        }

        function saveData() { localStorage.setItem(`shiro_sessions_${currentUser}`, JSON.stringify(sessions)); }

        // Copy Code Function
        function copyCode(btn) {
            const code = btn.parentElement.querySelector('code').innerText;
            const textarea = document.createElement('textarea');
            textarea.value = code;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            btn.innerText = "Copied! ‚ú®";
            setTimeout(() => btn.innerText = "Copy", 2000);
        }

        function renderMessage(sender, text, image = null) {
            const box = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2`;
            
            const content = document.createElement('div');
            content.className = `p-5 text-sm max-w-[85%] prose ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            
            if(image) content.innerHTML += `<img src="${image}" class="max-w-xs rounded-2xl mb-3 border-2 border-white shadow-md">`;
            
            if(text) {
                // Parse markdown
                const htmlContent = marked.parse(text);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Add copy buttons to code blocks
                tempDiv.querySelectorAll('pre').forEach(pre => {
                    const btn = document.createElement('button');
                    btn.className = "copy-btn";
                    btn.innerText = "Copy";
                    btn.onclick = () => copyCode(btn);
                    pre.appendChild(btn);
                });
                
                content.innerHTML += tempDiv.innerHTML;
            }
            
            msgDiv.appendChild(content);
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text && !selectedImageUrl) return;

            const session = sessions.find(s => s.id === activeSessionId);
            if(session.messages.length === 0 && text) {
                session.title = text.length > 20 ? text.substring(0, 20) + "..." : text;
                renderSessions();
            }

            const imgData = selectedImageUrl;
            session.messages.push({sender: 'user', text, image: imgData});
            renderMessage('user', text, imgData);
            input.value = '';
            input.style.height = '';
            clearImage();

            const typing = document.createElement('div');
            typing.id = "typing";
            typing.className = "p-4 chat-bubble-ai w-fit italic text-xs";
            typing.innerHTML = `Shiroko sedang mengetik... <span class="typing-dot">üå∏</span>`;
            document.getElementById('chat-box').appendChild(typing);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;

            try {
                const res = await fetch("https://rynekoo-api.hf.space/text.gen/gemini/2.5-pro", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, systemPrompt: SYSTEM_PROMPT, imageUrl: imgData, sessionId: activeSessionId })
                });
                const data = await res.json();
                document.getElementById('typing')?.remove();
                if(data.success) {
                    session.messages.push({sender: 'bot', text: data.result});
                    renderMessage('bot', data.result);
                } else renderMessage('bot', "Ehh, Shiroko lagi error Senpai! (‚ï•Ôπè‚ï•)");
            } catch (e) {
                document.getElementById('typing')?.remove();
                renderMessage('bot', "Sinyal Shiroko ilang! üì°");
            }
            saveData();
        }

        function previewImage(input) {
            if (input.files?.[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    selectedImageUrl = e.target.result;
                    document.getElementById('image-preview').src = selectedImageUrl;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage() {
            selectedImageUrl = "";
            document.getElementById('file-input').value = "";
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        function handleLogout() { localStorage.removeItem('shiro_active_user'); location.reload(); }
        document.getElementById('user-input').addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    </script>
</body>
</html>
